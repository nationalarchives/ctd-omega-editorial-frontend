@*
 * Copyright (c) 2022 The National Archives
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *@

@import helper._
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import uk.gov.hmrc.govukfrontend.views.viewmodels.fieldset.Legend
@import uk.gov.nationalarchives.omega.editorial.models._
@import uk.gov.nationalarchives.omega.editorial.controllers.EditSetController.FieldNames
@import uk.gov.nationalarchives.omega.editorial.forms.EditSetRecordFormValues
@import uk.gov.hmrc.hmrcfrontend.views.Implicits.RichErrorSummary

@import uk.gov.hmrc.govukfrontend.views.html.components.implicits._

@this(govukButton: GovukButton, govukInput: GovukInput, govukTextarea: GovukTextarea, govukFieldset: GovukFieldset, govukErrorSummary: GovukErrorSummary, govukSelect: GovukSelect)
@(
  user: User,
  editSetName: String,
  title: String,
  record: EditSetRecord,
  legalStatusReferenceData: Seq[LegalStatus],
  corporateBodies: Seq[CorporateBody],
  editSetRecordForm: Form[EditSetRecordFormValues]
)(implicit messages: Messages, request: Request[AnyContent])



@legalStatusItems = @{
    Seq(SelectItem(
        value = None,
        text = "Select a Legal Status",
    ))
}

@noListItem = {
  <li>@messages("edit-set.record.edit.no-list-items")</li>
}

@relatedMaterialLink(link: RelatedMaterial.LinkOnly) = {
  <li><a href="@link.linkHref">@link.linkText</a></li>
}

@relatedMaterialDescription(description: RelatedMaterial.DescriptionOnly) = {
  <li><span>@description.description</span></li>
}

@relatedMaterialLinkAndDescription(linkAndDescription: RelatedMaterial.LinkAndDescription) = {
  <li><a href="@linkAndDescription.linkHref">@linkAndDescription.linkText</a> - <span>@linkAndDescription.description</span></li>
}

@separatedMaterialLink(link: SeparatedMaterial.LinkOnly) = {
  <li><a href="@link.linkHref">@link.linkText</a></li>
}

@separatedMaterialDescription(description: SeparatedMaterial.DescriptionOnly) = {
  <li><span>@description.description</span></li>
}

@separatedMaterialLinkAndDescription(linkAndDescription: SeparatedMaterial.LinkAndDescription) = {
  <li><a href="@linkAndDescription.linkHref">@linkAndDescription.linkText</a> - <span>@linkAndDescription.description</span></li>
}

@backLink = {
  <a class="govuk-back-link" href="/edit-set/1">@messages("edit-set.record.edit.back-to-edit-set", editSetName)</a>
}

@actionButtonGroup = {
    <div class="govuk-button-group">
        @govukButton(Button(
            element = Some("button"),
            name = Some("action"),
            value = Some("save"),
            content = Text(messages("edit-set.record.save.button"))))
        @govukButton(Button(
            element = Some("button"),
            name = Some("action"),
            value = Some("discard"),
            classes = "govuk-button--secondary",
            content = Text(messages("edit-set.record.discard.button"))))
    </div>
}

@dateSelector(prefix: String, labelKey: String) = {
    <label class="govuk-label govuk-label--s">
    @messages(labelKey)
    </label>
@editSetRecordForm.error(prefix + "-date-day").map { error =>
    <p id="@{prefix}-date-field-error" class="govuk-error-message">@{error.message}</p>
}
    <div class="govuk-date-input" id="@prefix">
        <div class="govuk-date-input__item">
            <div class="govuk-form-group">
            @govukInput(Input(
                id = prefix + "-date-day",
                name = prefix + "-date-day",
                value = editSetRecordForm.data.get(prefix + "-date-day"),
                label = Label(classes = "govuk-label govuk-date-input__label", forAttr = Some("@{prefix}-date-day"), content = Text(messages("edit-set.record.edit.dates.day"))),
                classes = "govuk-input govuk-date-input__input govuk-input--width-2"))
            </div>
        </div>
        <div class="govuk-date-input__item">
            <div class="govuk-form-group">
            @govukInput(Input(
                id = prefix + "-date-month",
                name = prefix + "-date-month",
                value = editSetRecordForm.data.get(prefix + "-date-month"),
                label = Label(classes = "govuk-label govuk-date-input__label", forAttr = Some("@{prefix}-date-month"), content = Text(messages("edit-set.record.edit.dates.month"))),
                classes = "govuk-input govuk-date-input__input govuk-input--width-2"))
            </div>
        </div>
        <div class="govuk-date-input__item">
            <div class="govuk-form-group">
            @govukInput(Input(
                id = prefix + "-date-year",
                name = prefix + "-date-year",
                value = editSetRecordForm.data.get(prefix + "-date-year"),
                label = Label(classes = "govuk-label govuk-date-input__label", forAttr = Some("@{prefix}-date-year"), content = Text(messages("edit-set.record.edit.dates.year"))),
                classes = "govuk-input govuk-date-input__input govuk-input--width-4"))
            </div>
        </div>
    </div>
}

@fieldsetContent = {
@CSRF.formField
@govukTextarea(Textarea(
    id = FieldNames.scopeAndContent,
    name = FieldNames.scopeAndContent,
    value = editSetRecordForm.data.get(FieldNames.scopeAndContent),
    label = Label(
      forAttr = Some(FieldNames.scopeAndContent),
      content = Text(messages("edit-set.record.edit.scope-and-content")),
      classes = "govuk-label--s"
    ),
    errorMessage = editSetRecordForm.error(FieldNames.scopeAndContent).map { error =>
        ErrorMessage(
            content = Text(error.message),
            attributes = Map("for" -> FieldNames.scopeAndContent)
        )
    },
    attributes = Map("rows" -> "5", "autofocus" -> "true")))
@govukInput(Input(
    id = FieldNames.formerReferenceDepartment,
    name = FieldNames.formerReferenceDepartment,
    value = editSetRecordForm.data.get(FieldNames.formerReferenceDepartment),
    label = Label(
      forAttr = Some(FieldNames.formerReferenceDepartment),
      content = Text(messages("edit-set.record.edit.former-reference")),
      classes = "govuk-label--s"
    ),
    errorMessage = editSetRecordForm.error(FieldNames.formerReferenceDepartment).map { error =>
        ErrorMessage(
            content = Text(error.message),
            attributes = Map("for" -> FieldNames.formerReferenceDepartment)
        )
    },
    classes = "govuk-input--width-20"))
@govukInput(Input(
    id = FieldNames.coveringDates,
    name = FieldNames.coveringDates,
    attributes = Map(),
    value = editSetRecordForm.data.get(FieldNames.coveringDates),
    label = Label(
      forAttr = Some(FieldNames.coveringDates),
      content = Text(messages("edit-set.record.edit.covering-dates")),
      classes = "govuk-label--s"
    ),
    errorMessage = editSetRecordForm.error(FieldNames.coveringDates).map { error =>
        ErrorMessage(
            content = Text(error.message),
            attributes = Map("for" -> FieldNames.coveringDates)
        )
    },
    classes = "govuk-!-width-one-half"))

@govukButton(Button(
    element = Some("button"),
    name = Some("action"),
    value = Some("calculateDates"),
    content = Text(messages("edit-set.record.calculate-dates.button"))))

@govukFieldset(
    Fieldset(
        classes = "govuk-fieldset",
        html = dateSelector("start", "edit-set.record.edit.start-date"),
        role = Some("group")
    ))
@govukFieldset(
    Fieldset(
        classes = "govuk-fieldset",
        html = dateSelector("end", "edit-set.record.edit.end-date"),
        role = Some("group")
    ))
@govukSelect(Select(
    id = FieldNames.legalStatus,
    name = FieldNames.legalStatus,
    items = legalStatusItems ++ legalStatusReferenceData.map { status =>
        SelectItem(
            selected = editSetRecordForm.data.get(FieldNames.legalStatus).contains(status.uri),
            text = status.label,
            value = Some(status.uri)
        )
    },
    label = Label(
      forAttr = Some(FieldNames.legalStatus),
      content = Text(messages("edit-set.record.edit.legal-status")),
      classes = "govuk-label--s"
    ),
    errorMessage = editSetRecordForm.error(FieldNames.legalStatus).map { error =>
        ErrorMessage(
            content = Text(error.message),
            attributes = Map("for" -> FieldNames.legalStatus)
        )
    },
)
)

@govukTextarea(Textarea(
    id = FieldNames.custodialHistory,
    name = FieldNames.custodialHistory,
    value = editSetRecordForm.data.get(FieldNames.custodialHistory),
    label = Label(forAttr = Some(FieldNames.custodialHistory), classes = "govuk-label--s", content = Text(messages("edit-set.record.edit.custodial-history"))),
    errorMessage = editSetRecordForm.error(FieldNames.custodialHistory).map { error =>
        ErrorMessage(
            content = Text(error.message),
            attributes = Map("for" -> FieldNames.custodialHistory)
        )
    },
    attributes = Map("rows" -> "5", "autofocus" -> "true")
)
)

@govukSelect(Select(
    id = FieldNames.placeOfDeposit,
    name = FieldNames.placeOfDeposit,
    items = {
        val noSelectionAsMap = Map("" -> messages("edit-set.record.error.place-of-deposit"))
        val corporateBodiesAsMap = noSelectionAsMap ++ corporateBodies.map(corporateBody => (corporateBody.id, corporateBody.name)).toMap
        corporateBodiesAsMap
                .map { case (id, label) =>
            SelectItem(
                selected = editSetRecordForm.data.get(FieldNames.placeOfDeposit).contains(id),
                text = label,
                value = Some(id).filter(_.nonEmpty),
                disabled = id == ""
            )
        }.toSeq
    },
    label = Label(
      forAttr = Some(FieldNames.placeOfDeposit),
      content = Text(messages("edit-set.record.edit.place-of-deposit")),
      classes = "govuk-label--s"
    ),
    errorMessage = editSetRecordForm.error(FieldNames.placeOfDeposit).map { error =>
        ErrorMessage(
            content = Text(error.message),
            attributes = Map("for" -> FieldNames.placeOfDeposit)
        )
    },
)
)
@govukTextarea(Textarea(
    id = FieldNames.note,
    name = FieldNames.note,
    value = editSetRecordForm.data.get(FieldNames.note),
    label = Label(
      forAttr = Some(FieldNames.note),
      content = Text(messages("edit-set.record.edit.note")),
      classes = "govuk-label--s"
    ),
    errorMessage = editSetRecordForm.error(FieldNames.note).map { error =>
        ErrorMessage(
            content = Text(error.message),
            attributes = Map("for" -> FieldNames.note)
        )
    },
    attributes = Map("rows" -> "5", "autofocus" -> "true")))
@govukTextarea(Textarea(
    id = FieldNames.background,
    name = FieldNames.background,
    value = editSetRecordForm.data.get(FieldNames.background),
    label = Label(forAttr = Some(FieldNames.background), classes = "govuk-label--s", content = Text(messages("edit-set.record.edit.background"))),
    errorMessage = editSetRecordForm.error(FieldNames.background).map { error =>
        ErrorMessage(
            content = Text(error.message),
            attributes = Map("for" -> FieldNames.background)
        )
    },
    attributes = Map("rows" -> "5", "autofocus" -> "true")))



  <h3 class="govuk-heading-s">@messages("edit-set.record.edit.related-material")</h3>
  <ul id="related-material" class="govuk-list govuk-list--bullet">
    @{
      if (record.relatedMaterial.isEmpty)
        noListItem
      else
        record.relatedMaterial.map {

          case e: RelatedMaterial.LinkAndDescription =>
            relatedMaterialLinkAndDescription(e)

          case e: RelatedMaterial.LinkOnly =>
            relatedMaterialLink(e)

          case e: RelatedMaterial.DescriptionOnly =>
            relatedMaterialDescription(e)

        }
    }
  </ul>

  <h3 class="govuk-heading-s">@messages("edit-set.record.edit.separated-material")</h3>
  <ul id="separated-material" class="govuk-list govuk-list--bullet">
    @{
      if (record.separatedMaterial.isEmpty)
        noListItem
      else
        record.separatedMaterial.map {

          case e: SeparatedMaterial.LinkAndDescription =>
            separatedMaterialLinkAndDescription(e)

          case e: SeparatedMaterial.LinkOnly =>
            separatedMaterialLink(e)

          case e: SeparatedMaterial.DescriptionOnly =>
            separatedMaterialDescription(e)

        }
    }
  </ul>

    <div class="govuk-form-group">
        <input id="@FieldNames.ccr" name="ccr" type="text" readonly="readonly" hidden="true" value="@record.ccr"/>
        <input id="@FieldNames.oci" name="oci" type="text" readonly="readonly" hidden="true" value="@record.oci"/>
    </div>
@actionButtonGroup
}

@template(Some(user), title, Some(backLink)) {
    @if(editSetRecordForm.hasErrors) {
        @govukErrorSummary(ErrorSummary().withFormErrorsAsText(editSetRecordForm))
    }
    <h1 class="govuk-heading-l">@messages("edit-set.record.edit.heading", record.ccr)</h1>
    <h2 class="govuk-heading-m">@messages("edit-set.record.edit.id", record.oci)</h2>
    <p class="govuk-body">@messages("placeholder.series-national-coal-board")</p>
    <hr class="govuk-section-break govuk-section-break--xl govuk-section-break--visible">
    @helper.form(action = uk.gov.nationalarchives.omega.editorial.controllers.routes.EditSetController.submit("1", record.oci)) {
        @actionButtonGroup
        @govukFieldset(Fieldset(
            html = fieldsetContent,
            legend = Some(Legend(
                classes = "govuk-fieldset__legend govuk-fieldset__legend--l",
                content = Text(messages("edit-set.record.edit.legend")
                ))
            )))
    }
}
